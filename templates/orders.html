{% extends "base.html" %}
{% block content %}

<div class="orders-page">
  <h2>Your Orders</h2>

  {% if data|length == 0 %}
    <p>No orders placed yet.</p>
  {% endif %}

  {% for entry in data %}
  <div class="order-card">

    <!-- HEADER -->
    <div class="order-header">
      <h3>Order #{{ entry.order.id }}</h3>

      <div>
        <span class="order-total">₹{{ entry.order.total }}</span>

        {% if entry.order.status != "Cancelled" %}
        <a href="{{ url_for('generate_invoice', order_id=entry.order.id) }}"
           style="margin-left:10px;
                  padding:4px 8px;
                  background:#28a745;
                  color:white;
                  border-radius:4px;
                  font-size:12px;
                  text-decoration:none;">
           Invoice
        </a>
        {% endif %}
      </div>
    </div>

    <p class="muted">
      Payment: {{ entry.order.payment_method|upper }}
    </p>

    <!-- LIVE STATUS -->
    <p class="status-text">
      Status:
      <span class="live-status" data-order-id="{{ entry.order.id }}">
        {{ entry.order.status }}
      </span>
    </p>

    <p class="success-msg" id="msg-{{ entry.order.id }}"></p>

    <!-- TIMELINE -->
    <ul class="timeline" data-order-id="{{ entry.order.id }}">
      {% set steps = ["Pending","Accepted","Preparing","Out for Delivery","Delivered"] %}

      {% if entry.order.status == "Cancelled" %}
        {% for step in steps %}
          <li class="pending">{{ step }}</li>
        {% endfor %}
        <li class="done cancelled">Cancelled</li>
      {% else %}
        {% for step in steps %}
          <li class="{% if steps.index(step) <= steps.index(entry.order.status) %}done{% else %}pending{% endif %}">
            {{ step }}
          </li>
        {% endfor %}
      {% endif %}
    </ul>

    <!-- STATUS HISTORY -->
    <div class="status-history">
      <h4>Status History</h4>
      <ul>
        {% for h in entry.history %}
          <li>
            {{ h.status }}
            <span>{{ h.changed_at.strftime('%d %b %Y, %I:%M %p') }}</span>
          </li>
        {% endfor %}
      </ul>
    </div>

    <!-- ORDER ITEMS -->
    <div class="order-items">
      {% for item in entry["items"] %}
        <div class="order-item">
          <span>{{ item.food_name }} × {{ item.quantity }}</span>
          <span>₹{{ item.price * item.quantity }}</span>
        </div>
      {% endfor %}
    </div>

    <!-- CANCEL BUTTON -->
    {% if entry.order.status in ["Pending","Accepted"] %}
      <form method="POST" action="/cancel-order/{{ entry.order.id }}" style="margin-top:15px;">
        <button style="background:#ff4d4d;">Cancel Order</button>
      </form>
    {% endif %}

  </div>
  {% endfor %}
</div>

<script>
function pollOrderStatus() {
  document.querySelectorAll(".live-status").forEach(span => {
    const orderId = span.dataset.orderId;

    fetch(`/api/order-status/${orderId}`)
      .then(res => res.json())
      .then(data => {
        if (!data.success) return;
        span.innerText = data.status;
      });
  });
}

setInterval(pollOrderStatus, 5000);
pollOrderStatus();
</script>

{% endblock %}
